<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRUOP</title>

    <link rel="stylesheet" href="/static/css/history.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">

    <script src="/static/js/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- gaugechart -->
</head>
<body>
    <!-- 사이드바 -->
    <div id="sidebar" class="sidebar">
        <ul>
            <li>
                <a href="#">회원정보 수정</a>
            </li>
            <li>
                <a href="/templates/history.html">이력 조회</a>
            </li>
            <li>
                <a href="/templates/mystudy.html">내스터디</a>
            </li>
        </ul>
    </div>
    <!-- 사이드바 끝-->

    <!-- 사이드바 외 본문 시작 -->
    <div id="main">
        <button class="sidebar-btn" onclick="Sidebar_move()">☰</button>
    </div>
    <!-- 사이드바 외 본문 시작 끝 -->

    <!-- 상단 바-->
    <header>
        <div class="logo">SROUP</div>
        <div>
            <button onclick="location.href='login.html';">로그인</button>
            <button onclick="location.href='create_group.html';">그룹생성</button>
            <button onclick="location.href='mypage.html';">마이페이지</button>
            <button onclick="location.href='logout.html';">로그아웃</button>
        </div>
    </header>

    <!-- dashboard -->
    <div class="tab-container">
        <ul class="tabs">
            <li class="tab" data-tab="tab1">Group Board</li>
            <li class="tab" data-tab="tab2">My Board</li>
            <li class="tab" data-tab="tab3">Member</li>
        </ul>

        <div class="tab-content" id="tab1" >

        </div>
        <div class="tab-content" id="tab2">
            <div class="tab-study" id="tab2-1"> 
                <h2>STUDY TIMER</h2>
                <button class="timer-btn"> ON </button> 

            </div> 

            <div class="tab-study" id="tab2-2"> 
                <h2> 🔔 알림 </h2> 
            </div>
            <div class="popup-overlay"></div>
            <div class="popup" id="popup2">
                <h2>알림 </h2>
                <p> 알림 내용 </p>
            </div>

            <div class="tab-study" id="tab2-3">
                <h2 id="write-tab"> 회고록 ✏️</h2> 
                <div class="date-navigation">
                    <button id="prev-date">&lt;</button>
                    <span id="current-date"> 0000.00.00 </span> 
                    <button id="next-date">&gt;</button>
                </div>
                <div class="study-content" id="study-content">
                    작성된 내용이 없습니다.
                </div>
            </div>

            <!-- 팝업 코드 -->
            <div class="popup-overlay"></div>
            <div class="popup" id="popup3">
                <h2> 회고록 </h2>
                <form>
                    <input type="text" id="title" placeholder="제목" required>
                    <p></p>
                    <textarea type="text" id="content" placeholder="내용을 입력해주세요" required> </textarea>
                    <button class="upload"> 등록하기 </button>
                </form>
            </div>


            <div class="tab-study" id="tab2-4"> 
                <canvas id="gaugeChart" style="height: 40vh"></canvas>
            </div>
            
            
            <div class="tab-study" id="tab2-5"> 수행률</div>
            <div class="tab-study" id="tab2-6">
                <div>
                    <div class="calendar">
                        <div class="calendar-header">
                            <button id="prev-month">&lt;</button>
                            <h2 id="month-year"></h2>
                            <button id="next-month">&gt;</button>
                        </div>
                        <div class="calendar-days">
                            <div>일</div>
                            <div>월</div>
                            <div>화</div>
                            <div>수</div>
                            <div>목</div>
                            <div>금</div>
                            <div>토</div>
                        </div>
                        <div class="days" id="days-content"></div>
                    </div>
                </div>
            </div>


            <div class="tab-study" id="tab2-7"> 달성률</div>
            <img id="tab2-8" src="https://ghchart.rshah.org/082918"/>
        </div>

        <div class="tab-content" id="tab3">
            <p>멤버명단</p>
        </div>
    </div>  


<script>
    // 알림 팝업 열기 
    const popupOverlay = document.querySelector(".popup-overlay");
    
    const tab2writer = document.querySelector("#tab2-2") 
    const popup2 = document.querySelector("#popup2");

    tab2writer.addEventListener("click", () => {
    popupOverlay.style.display = "block"; // overlay 배경 표시 
    popup2.style.display = "block";       // 팝업 표시
    });
    
    // 회고록 팝업 열기
    const tab3writer = document.querySelector("#write-tab") 
    const popup3 = document.querySelector("#popup3");
    
    tab3writer.addEventListener("click", () => {
    popupOverlay.style.display = "block"; // overlay 배경 표시 
    popup3.style.display = "block";       // 팝업 표시
    });    

    // 팝업 닫기 
    const closePopup = () => {
    popupOverlay.style.display = "none"; // overlay 배경 숨김 
    popup2.style.display = "none";     // 알림 팝업 닫기
    popup3.style.display = "none";     // 회고록 팝업 닫기 
    };

    popupOverlay.addEventListener("click", closePopup);   // overlay (창 밖 부분) 클릭 시 팝업 닫힘 

    // 회고록 날짜
    const currentDate = new Date(); // 현재 날짜 

    const currentDateElement = document.getElementById("current-date");
    const studycontent = document.getElementById("study-content") 
    const prevdate = document.getElementById("prev-date") 
    const nextdate = document.getElementById("next-date") 
    const popupdate = document.getElementById("popup-date");


    function formatDate(date) {
      return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, "0")}.${String(date.getDate()).padStart(2, "0")}`;
    };

    const records = {}; 

    function updateDateDisplay() {
      currentDateElement.textContent = formatDate(currentDate);
      const recordKey = formatDate(currentDate);
      studycontent.textContent = records[recordKey] || "회고록을 작성해주세요.";
    };

    // 이전날짜 회고록 
    prevdate.addEventListener("click", ()=> {
        currentDate.setDate(currentDate.getDate() -1);
        updateDateDisplay();
    });

    // 이후날짜 회고록
    nextdate.addEventListener("click", ()=> {
        currentDate.setDate(currentDate.getDate() +1);
        updateDateDisplay();
    });

    // 작성 버튼
    const uploadbtn = document.querySelector(".upload");

    // 회고록 작성 시 달력에 표시
    uploadbtn.addEventListener("click", (event) => {
    event.preventDefault();

    const title = document.getElementById("title").value;
    const content = document.getElementById("content").value;
    const recordKey = formatDate(currentDate);

    if (title && content) {
        // 회고록 데이터 저장
        records[recordKey] = { title, content };

        alert("회고록이 저장되었습니다!");
        closePopup(); // 팝업 닫기
        updateDateDisplay(); // 회고록 내용 갱신
        updateCalendar(currentDate); // 달력 갱신
    } else {
        alert("제목과 내용을 모두 입력해주세요.");
    }
    });

    // 타이머 
    var timerbtn = document.querySelector(".timer-btn")

    timerbtn.addEventListener("click", ()=> {
        const timerWindow = window.open(
        "studytimer.html", // 타이머 실행 (타이머 html)
        "타이머", // 타이머로 열 창 이름
        "width=400,height=300" // 타이머 창 크기 
        )

        if (!timerWindow) {
        alert("팝업 차단을 해주세요! 타이머 창을 열 수 없습니다.")
        }
    });

    // 달력
    const calendarcontent = document.getElementById("days-content");
    const monthyear = document.getElementById("month-year");
    const prevmonth = document.getElementById("prev-month");
    const nextmonth = document.getElementById("next-month");

    // 달력 업데이트 함수
    function updateCalendar(date) {
        const year = date.getFullYear();
        const month = date.getMonth();

        monthyear.textContent = `${year}년 ${month + 1}월`;

        const firstDay = new Date(year, month, 1).getDay(); // 이번 달 1일의 요일
        const lastDate = new Date(year, month + 1, 0).getDate(); // 이번 달의 마지막 날짜

        calendarcontent.innerHTML = ""; // 기존 내용 초기화

    // 빈 칸 추가
        for (let i = 0; i < firstDay; i++) {
            const emptyDiv = document.createElement("div");
            emptyDiv.classList.add("empty");
            calendarcontent.appendChild(emptyDiv);
        }

    // 날짜 추가
        for (let day = 1; day <= lastDate; day++) {
            const dayDiv = document.createElement("div");
            dayDiv.textContent = day;

            const recordKey = `${year}.${String(month + 1).padStart(2, "0")}.${String(day).padStart(2, "0")}`;

            // 회고록 작성 날짜
            if (records[recordKey]) {
                dayDiv.classList.add("has-record");
            }

            calendarcontent.appendChild(dayDiv);
        }

    };

    // 이전 달 버튼
    prevmonth.addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendar(currentDate);
    });

    // 다음 달 버튼
    nextmonth.addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendar(currentDate);
    });

    // 초기화
    updateCalendar(currentDate);
    updateDateDisplay(); // 회고록 날짜 초기화


    // 출석률 차트 
    var data = {
        value: 70,
        max: 100,
        label: "출석률"
    };
    
    var chartCtx = document.getElementById('gaugeChart').getContext('2d');

    var config = {
        type: 'doughnut',
        data: {
            labels: [data.label],
            datasets: [{
                data: [data.value, data.max - data.value],
                backgroundColor: ['#f0e53c', 'rgba(0, 0, 0, 0.1)'],
                borderWidth: 0
            }]
        },

        options: {
            responsive: true, // 차트 반응형 여부 설정 
            //maintainAspectRatio: false, // 가로세로 비율 유지 X
            cutoutPercentage: 85, // 도넛형 차트 가운데 비어있는 크기 설정 
            rotation: -90, 
            circumference: 180, 
            animation: {
                animateRotate: true,
                animateScale: false
            },
            title: {
                display: true,
                text: data.label,
                fontSize: 16
            }}
            
        };

        var gaugeChart = new Chart(chartCtx, config);

</script>

</body>

</html>
